<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Kashiwade Map</title>
<meta name="viewport" content="width=device-width,user-scalable=0">
<script src="https://maps.googleapis.com/maps/api/js?sensor=set_to_true_or_false"></script>
<script type="text/javascript" src="ncmb.min.js" charset="utf-8"></script>
<script src="kashiwade.js"></script>
 </head>
<body>
<div class="map-embed">
	<div id="maparea"></div>
</div>
<script type="text/javascript">
LoadClapWave();
var canvas = document.getElementById('maparea') ;

var mapOptions = {
	zoom: 10 ,				// ズーム値
	center: new google.maps.LatLng( 35.405826 , 139.5120954 ) ,		// 中心座標 [latlng]
	disableDefaultUI: true,
	mapTypeId: google.maps.MapTypeId.ROADMAP
};

var map = new google.maps.Map( canvas , mapOptions ) ;

var marker1 = new google.maps.Marker({
  position: new google.maps.LatLng(35.1598865,139.1359808),
  map: map,
  title: "真鶴1",
});
var marker2 = new google.maps.Marker({
  position: new google.maps.LatLng(35.7015253,139.7092071),
  map: map,
  title: "新宿",
});
var marker3 = new google.maps.Marker({
  position: new google.maps.LatLng(35.6295764,139.794686),
  map: map,
  title: "ビッグサイト",
});
var marker4= new google.maps.Marker({
  position: new google.maps.LatLng(35.5571491,139.6949123),
  map: map,
  title: "ポケモンセンター",
});
var infowindow;
var clapcounts={"ビッグサイト":0,"新宿":0,"真鶴1":0,"ポケモンセンター":0,"真鶴2":0 };
var ncmb = new NCMB("1be9dba7dec777026b5832322db9e5882f8e1cd5ed76fb7e45848657aa6c7ad3","af6b5030e091b942a843f099084821cd911e866622065d8f8c3a57c200f3dc3a");
var kashiwadeData = ncmb.DataStore("kashiwade");

function onclapdown()
{
	clapcounts[infowindow.markertitle]++;
	kashiwadeData.equalTo("title", infowindow.markertitle)
    	.fetchAll()
    	.then(function(results){
    		if (results[0]!=null) {
				results[0].setIncrement("num",1).update();
   			} else {
    		 	console.log("can't find data");
     		}
    	})
    	.catch(function(err){
    		console.log(err);
  		});
	var btnclap=document.getElementById('clapbtn');
	btnclap.addEventListener("mouseleave",onclapup,false);
	btnclap.style.backgroundImage='url(images/clap_2_c.png)';
 	document.getElementById('claptext').textContent=clapcounts[infowindow.markertitle]+'柏手';
	clap();
}
function onclapup()
{
	var btnclap=document.getElementById('clapbtn');
	btnclap.removeEventListener("mouseleave",onclapup,false);
	btnclap.style.backgroundImage='url(images/clap_1_c.png)';
}
function createMarkerInfo(marker,count)
{
	var htmltext="";
	htmltext+=marker.title+"<br/>";
	htmltext+='<img src="'+getImageURL(marker.title)+'"width="150" height="60"><br/>';
	htmltext+='<button onclick="Play()">Play</button><br/>';
	htmltext+='ReverbLevel : <input type="range" id="revlevel" min="0" max="100" value="50" onchange="setRevLevel()"/><br/>';
	htmltext+='SELevel :     <input type="range" id="selevel" min="0" max="100" value="50" onchange="setSELevel()"/><br/>';
	htmltext+='<div id="clapbtn"'
	htmltext+=' style="width:50px; height:50px; background-size:auto 100%; background-image:url(images/clap_1_c.png);"';
	htmltext+=' onmousedown="onclapdown()" onmouseup="onclapup()"';
	htmltext+='></div>';
	htmltext+='<div id="claptext">'+count+'柏手</div>';
  	infowindow = new google.maps.InfoWindow({
 		content: htmltext,
		position: marker.position
	});
	infowindow.open(map);
	infowindow.markertitle=marker.title;
	google.maps.event.addListener(infowindow,'closeclick', function() {
		Stop();
	});
	clapcounts[marker.title]=count;
}
function checkcount()
{
	if (infowindow) {
		kashiwadeData.equalTo("title", infowindow.markertitle)
    	.fetchAll()
    	.then(function(results){
    		if (results[0]!=null) {
    			var count=results[0].get("num");
    			if (count>clapcounts[infowindow.markertitle]) {
    				clapcounts[infowindow.markertitle]=count;
 					document.getElementById('claptext').textContent=count+'柏手';
    			}
    		}
    	})
    	.catch(function(err){
  		});
    }
}
var interval = setInterval('checkcount()',1000);
function doMarkerClick(marker)
{
	console.log(marker);
	loadContents(marker.title);
	if (infowindow) infowindow.close();
	kashiwadeData.equalTo("title", marker.title)
    	.fetchAll()
    	.then(function(results){
    		if (results[0]!=null) {
    			createMarkerInfo(marker,results[0].get("num"));
   			} else {
    		 	console.log("can't find data");
    		 	createMarkerInfo(marker,clapcounts[marker.title]);
     		}
    	})
    	.catch(function(err){
    		createMarkerInfo(marker,clapcounts[marker.title]);
  		});
};
google.maps.event.addListener(marker1, "mouseover", function() {
    doMarkerClick(marker1);
});
google.maps.event.addListener(marker2, "mouseover", function() {
    doMarkerClick(marker2);
});
google.maps.event.addListener(marker3, "mouseover", function() {
    doMarkerClick(marker3);
});
google.maps.event.addListener(marker4, "mouseover", function() {
    doMarkerClick(marker4);
});
</script>
<style type="text/css">
.map-embed
{
	max-width: 100% ;
	height: 0 ;
	/*height: 100%;*/
	margin: 0 ;
	padding: 0 0 180% 0 ;

	overflow: hidden ;

	position: relative ;
	top: 0 ;
	left: 0 ;
}

.map-embed > div
{
	position: absolute ;
	top: 0 ;
	left: 0 ;

	width: 100% ;
	height: 100% ;

	margin: 0 ;
	padding: 0 ;
}

.map-embed img
{
	max-width: none ;
}
</style>
</body>
</html>